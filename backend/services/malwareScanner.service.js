const clamav = require('clamav.js');
const net = require('net');
const stream = require('stream');

exports.scanFileBuffer = async (fileBuffer) => {
  return new Promise((resolve, reject) => {
    const bufferStream = new stream.PassThrough();
    bufferStream.end(fileBuffer);

    const socket = net.connect(3310, '127.0.0.1', () => {
      clamav.createScanner().scan(bufferStream, socket, (err, object, malicious) => {
        if (err) {
          console.error('ClamAV scan error:', err);
          reject(new Error("Failed to scan the file."));
        } else if (malicious) {
          console.log(`Threat Detected: ${malicious}`);
          resolve({ isSafe: false, viruses: [malicious] });
        } else {
          resolve({ isSafe: true });
        }
      });
    });
  });
};
